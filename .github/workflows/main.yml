name: Build & Deploy

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    steps:
      - name: Install
        run: pnpm install

      - name: Build
        run: |
          pnpm run --prefix xmcl-keystone-ui build
          pnpm run --prefix xmcl-electron-app build:all

  Deploy Release:
    on:
      release:
        types: [published]

    jobs:
      publish:
        runs-on: ubuntu-latest
        steps:
          - name: Download Releases
            uses: robinraju/release-downloader@v1.7
            with:
              repository: "aislxflames/flame-launcher"
              tag: ${{ github.event.release.tag_name }}
              fileName: "*"
              out-file-path: build

          - name: Create release version file
            run: |
              mkdir releases
              echo ${{ github.event.release.tag_name }} > ./releases/VERSION
              cat << EOF > ./releases/latest_version.json
              ${{ toJSON(github.event.release) }}
              EOF
